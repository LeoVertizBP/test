# Data Fetching & Storage

## Overview

This document describes how the Credit Compliance Tool stores persistent data and how the backend application fetches and manipulates this data.

## Key Concepts

*   **Primary Storage:** PostgreSQL is used as the relational database for storing all structured application data (users, rules, scans, content metadata, flags, etc.).
*   **Object Relational Mapper (ORM):** Prisma is employed as the ORM. It provides a type-safe database client and manages schema migrations.
*   **Schema Definition:** The database schema is defined declaratively in `prisma/schema.prisma`. This file serves as the single source of truth for database models and their relations. Key tables include those for users, publishers, channels, scan jobs, content items, flags, rules, and configurations. Notably, the `publisher_channel_configs` table stores specific crawl settings (limits, domains, credentials references, etc.) for individual publisher website channels.
*   **Prisma Client:** A type-safe database client is generated by Prisma (`generated/prisma`) based on the schema definition. This client is used throughout the backend services and repositories to interact with the database.
    *   **Migrations:** Prisma Migrate (and potentially `node-pg-migrate` as seen in `package.json`) is used to manage database schema changes over time, ensuring the database structure stays synchronized with the application's expectations.
*   **Repository Pattern:** The backend utilizes the repository pattern (evident from `src/repositories/`) to abstract the data access logic. Each major database entity (e.g., `users`, `scan_jobs`, `flags`) typically has a corresponding repository file (e.g., `userRepository.ts`, `scanJobRepository.ts`, `flagRepository.ts`). Repositories encapsulate Prisma Client calls for specific models.
*   **Service Layer:** Services (`src/services/`) contain the core business logic and orchestrate data operations by calling methods on one or more repositories.
*   **Media Storage:** Binary media files (images, videos) associated with content items are not stored directly in the database. Instead, they are uploaded to Google Cloud Storage (GCS), and the database (`content_images` table) stores references (file paths/URLs) to these objects in GCS. The `gcsService.ts` handles interactions with GCS.

## Implementation

### Data Flow (Typical Read Operation)

1.  An HTTP request hits an API endpoint in the backend (`src/routes/`).
2.  The route handler calls a method in the relevant Service (`src/services/`).
3.  The Service method calls one or more methods in the appropriate Repository (`src/repositories/`).
4.  The Repository method uses the generated Prisma Client to query the PostgreSQL database.
5.  Prisma translates the query into SQL, executes it, and maps the results back to TypeScript objects.
6.  The data flows back up through the layers to the API response.

### Data Flow (Typical Write Operation)

1.  An HTTP request (e.g., POST, PUT, DELETE) hits an API endpoint.
2.  The route handler calls a Service method with the data payload.
3.  The Service performs business logic/validation and calls a Repository method.
4.  The Repository method uses the Prisma Client to perform the create, update, or delete operation in the database.
5.  The result flows back up to the API response.

### Schema Management

*   **Definition:** `prisma/schema.prisma`
*   **Migrations:** Managed via Prisma Migrate commands (e.g., `npx prisma migrate dev`, `npx prisma migrate deploy`) and potentially `node-pg-migrate` scripts (`npm run migrate`).

```mermaid
graph TD
    subgraph "Application Backend"
        API[API Routes] --> Services[Service Layer]
        Services --> Repositories[Repository Layer]
        Repositories --> PrismaClient[Prisma Client]
    end

    subgraph "Data Stores"
        PrismaClient -- SQL --> DB[(PostgreSQL Database)];
        Services --> GCS[Google Cloud Storage];
    end

    PrismaClient -- Manages --> Schema(prisma/schema.prisma);
    Schema -- Generates --> PrismaClient;
    DB -- Stores --> StructuredData[Structured Data];
    GCS -- Stores --> MediaFiles[Media Files (Images/Videos)];

    style DB fill:#D1E8FF,stroke:#333,stroke-width:2px
    style GCS fill:#FFE8D1,stroke:#333,stroke-width:2px
```

## Integration Points

*   **Prisma Client:** The primary interface between the backend application code and the PostgreSQL database.
*   **PostgreSQL Database:** The persistent storage layer.
*   **Google Cloud Storage:** The storage layer for binary media files.
*   **Migration Tools:** Prisma Migrate / `node-pg-migrate` for evolving the database schema.

## Best Practices

*   **Type Safety:** Leverage Prisma's generated types throughout the backend to ensure data consistency and catch errors at compile time.
*   **Repository Abstraction:** Keep database query logic contained within repositories. Services should interact with repositories, not directly with the Prisma Client where possible.
*   **Transaction Management:** For operations involving multiple database writes that must succeed or fail together, use Prisma's transaction capabilities.
*   **Connection Pooling:** Prisma Client manages database connection pooling automatically. Ensure the `DATABASE_URL` environment variable is configured correctly.
*   **Schema Synchronization:** Always run migrations after changing `prisma/schema.prisma` to keep the database structure in sync. Regenerate the Prisma client (`npx prisma generate`) if not handled automatically.
