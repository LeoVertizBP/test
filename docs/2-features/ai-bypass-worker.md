# Feature: AI Confidence Bypass Worker

## 1. Feature Overview

**Goal:** To automate the processing (closing compliant flags, sending violations to remediation) of AI-generated flags based on their confidence score exceeding a user-defined threshold, thereby saving manual review time for high-confidence AI assessments.

**Core Components:**

*   **Settings UI:** Frontend interface for users to configure the bypass threshold, enable/disable specific automatic actions, apply settings retroactively, clear settings, and revert the last batch of automated actions.
*   **Backend Settings API:** Endpoints to save/retrieve bypass settings per organization and log these changes.
*   **Backend Worker (Post-Scan):** A background process triggered after a scan job's AI analysis completes, which applies the organization's current bypass settings to the flags generated by that specific job.
*   **Backend Worker (Retroactive):** A background process triggered manually via the API when settings are saved with the "Apply Retroactively" option, which applies the *current* settings to existing pending flags for the organization.
*   **Revert Mechanism:** An API endpoint to undo the flag status changes made by the *most recent* run of the bypass worker (either post-scan or retroactive) based on the last settings change.
*   **Audit Logging:** Detailed logging of when settings are changed (who, what settings) and when flags are automatically processed (which flag, what action, linked to the settings event).
*   **Per-Job Override:** Ability to disable the bypass feature for specific scan jobs.

## 2. How it Works (Backend Implementation)

*   **Settings Storage (`organizations` table):**
    *   `auto_approval_threshold: Decimal?`: Stores the confidence threshold (0.00-1.00, nullable). `null` means bypass is disabled.
    *   `auto_approve_compliant_enabled: Boolean? @default(false)`: Controls if compliant flags above threshold are auto-closed.
    *   `auto_remediate_violation_enabled: Boolean? @default(false)`: Controls if violation flags above threshold are auto-sent to remediation.
*   **Flag Status (`flags` table):**
    *   `status: FlagStatus`: Updated to `CLOSED` or `REMEDIATING` by the worker.
    *   `resolution_method: ResolutionMethod?`: Set to `AI_AUTO_CLOSE` or `AI_AUTO_REMEDIATE` to mark automatically processed flags. (Requires adding these to the enum).
*   **Scan Job Override (`scan_jobs` table):**
    *   `bypass_ai_processing: Boolean @default(false)`: If true, the post-scan worker skips processing for this job.
*   **Audit Logging (`audit_logs` table):**
    *   `triggering_event_log_id: String? @db.Uuid`: (New field, indexed) Links a flag update log back to the specific settings change log that triggered the automatic action.
    *   **Settings Change Log:** Action="AI Bypass Settings Updated/Cleared", `user_id` present, `details` contains new settings (threshold, booleans).
    *   **Flag Update Log:** Action="AI Bypass - Auto Closed/Remediated", `details` contains `{ "flag_id": "..." }`, `triggering_event_log_id` links to the settings change log, `user_id` is null (system action).
    *   **Revert Log:** Action="AI Bypass Reverted", `details` contains `{ "flag_id": "..." }`, `user_id` present (user who initiated revert).
*   **API - Settings:**
    *   `POST /api/system-settings/ai-bypass-threshold`:
        *   Accepts `threshold` (number 0-100 or null to clear), `autoApproveCompliant` (boolean), `autoRemediateViolation` (boolean), `applyRetroactively` (boolean).
        *   Validates input.
        *   Updates organization settings (converts threshold to Decimal or null, saves booleans). Sets booleans to `false` if threshold is cleared.
        *   Creates "AI Bypass Settings Updated/Cleared" audit log entry, storing its ID.
        *   If `applyRetroactively` is true, adds a job to `retroactiveBypassQueue` passing `organizationId` and the settings audit log ID.
        *   Returns success/failure.
    *   `GET /api/system-settings/ai-bypass-settings`:
        *   Fetches current `auto_approval_threshold`, `auto_approve_compliant_enabled`, `auto_remediate_violation_enabled` for the user's organization.
        *   Converts threshold back to percentage (0-100) or null.
        *   Returns settings.
*   **API - Scan Jobs:**
    *   Update `POST /api/scan-jobs` and `PUT /api/scan-jobs/:id` to accept and save the `bypass_ai_processing` boolean field.
*   **API - Revert:**
    *   `POST /api/system-settings/revert-auto-bypass`:
        *   Requires `organizationId`.
        *   Finds the most recent "AI Bypass Settings Updated/Cleared" log for the org to get the latest `triggering_event_log_id`.
        *   Finds all "AI Bypass - Auto Closed/Remediated" logs with that `triggering_event_log_id`.
        *   For each associated `flag_id`:
            *   Checks if the flag's current `resolution_method` is `AI_AUTO_CLOSE` or `AI_AUTO_REMEDIATE`.
            *   If yes, updates flag `status` to `PENDING` and `resolution_method` to `null`.
            *   Creates a "AI Bypass Reverted" audit log entry for the flag change, including the user ID.
        *   Returns success/failure.
*   **Worker - Main (`aiBypassQueue`):**
    *   Triggered by `scanJobService` after AI analysis completes for a job, receives `scan_job_id`.
    *   Gets `scanJob` details, checks `bypass_ai_processing`. If true, exits.
    *   Gets `organizationId` from the job.
    *   Fetches organization's current bypass settings and the ID of the latest settings change log (`triggering_event_log_id`).
    *   If threshold is null or both boolean toggles are false, exits.
    *   Queries `PENDING` flags for this `scan_job_id`.
    *   Loops through flags:
        *   If `flag.ai_confidence > threshold`:
            *   If `ai_ruling` is "Compliant" AND `auto_approve_compliant_enabled`: Update status to `CLOSED`, method to `AI_AUTO_CLOSE`, log action with `flag_id` and `triggering_event_log_id`.
            *   If `ai_ruling` is "Violation" AND `auto_remediate_violation_enabled`: Update status to `REMEDIATING`, method to `AI_AUTO_REMEDIATE`, log action with `flag_id` and `triggering_event_log_id`.
*   **Worker - Retroactive (`retroactiveBypassQueue`):**
    *   Triggered by Settings API, receives `organizationId` and `triggering_event_log_id`.
    *   Fetches organization's current bypass settings.
    *   If threshold is null or both boolean toggles are false, exits.
    *   Queries *all* `PENDING` flags for the `organizationId`.
    *   Performs the same loop/check/update/log logic as the Main Worker, using the provided `triggering_event_log_id`.

## 3. Required Frontend Changes

*   **AI Bypass Settings Page (`AIConfidenceBypassControl.tsx`):**
    *   **On Load:** Fetch current settings via `GET /api/system-settings/ai-bypass-settings`.
    *   **Display:** Show the currently saved threshold and boolean states clearly (e.g., "Current Setting: 85%, Auto-Close: Yes, Auto-Remediate: No").
    *   **Initialize Controls:** Set the initial state of the slider, number input, and new toggles/checkboxes based on the fetched settings.
    *   **New Controls:**
        *   Toggle/Checkbox: "Automatically close compliant flags above threshold" (maps to `autoApproveCompliant`).
        *   Toggle/Checkbox: "Automatically send violation flags above threshold to remediation" (maps to `autoRemediateViolation`).
        *   Checkbox: "Apply this setting to all existing pending flags" (maps to `applyRetroactively`).
    *   **Buttons:**
        *   "Set Bypass Threshold": Sends current control states (threshold, booleans, retroactive flag) to `POST /api/system-settings/ai-bypass-threshold`.
        *   "Clear/Disable Bypass": Sends `threshold: null` (and potentially booleans as false) to `POST /api/system-settings/ai-bypass-threshold`.
        *   "Revert Last Auto-Processing Batch": Calls `POST /api/system-settings/revert-auto-bypass` (needs confirmation modal).
*   **Scan Job Create/Edit Page:**
    *   Add Checkbox: "Disable AI Bypass for this job?" (maps to `bypass_ai_processing`).
    *   Update API calls for creating/editing scan jobs to include this new field.

## 4. User Stories

1.  **Setting Up Auto-Processing for Future Scans:** As a Compliance Manager, I want to go to the AI Bypass settings, see current settings, set threshold to 90%, enable *only* "Auto-close compliant", save *without* applying retroactively, so that future scan job flags >90% confidence and compliant are auto-closed.
2.  **Setting Up Auto-Processing and Applying Retroactively:** As a Compliance Lead, I want to go to settings, set threshold to 85%, enable *both* "Auto-close compliant" and "Auto-remediate violations", check "Apply retroactively", so the system saves settings AND immediately processes all current `PENDING` flags based on these rules, and applies rules to future jobs.
3.  **Disabling Future Auto-Processing (Revised):** As a Compliance Manager, I want to go to settings, see current settings, click "Clear/Disable Bypass", so that the saved threshold/options are removed, ensuring no *new* flags from *future* scans are auto-processed. Past auto-processed flags remain unchanged.
4.  **Running a Scan Job with Bypass Enabled:** As a Compliance Analyst, I want to create a scan job, leaving "Disable AI Bypass" *unchecked*, so that after AI analysis, flags from *this job* are processed against the org's saved settings.
5.  **Running a Scan Job with Bypass Disabled:** As a Compliance Analyst, I want to create a scan job and *check* "Disable AI Bypass", so that *no* flags from *this specific job* are auto-processed, regardless of org settings.
6.  **Reverting the Last Auto-Processing Batch:** As a Compliance Manager, I want to click "Revert Last Auto-Processing Batch", so the system finds all flags automatically changed based on the *most recent* settings save (across any job or retroactive run) and reverts them to `PENDING` (if eligible).
7.  **Checking the Current Settings:** As a Team Member, I want to visit the settings page, so I can clearly see the currently saved threshold and which auto-actions are enabled before adjusting controls.
8.  **Auditing Auto-Processing Actions:** As an Auditor, I want to review audit logs, so I can see when bypass settings were changed (who, what), and which specific flags were auto-processed by the system based on those settings, linking flag changes back to the setting event.
