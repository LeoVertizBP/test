# Feature: AI Confidence Bypass Worker

## 1. Feature Overview

**Goal:** To automate the processing (closing compliant flags, sending violations to remediation) of AI-generated flags based on their confidence score exceeding a user-defined threshold, thereby saving manual review time for high-confidence AI assessments.

**Core Components:**

*   **Settings UI:** Frontend interface for users to configure the bypass threshold, enable/disable specific automatic actions, apply settings retroactively, clear settings, and revert the last batch of automated actions.
*   **Backend Settings API:** Endpoints to save/retrieve bypass settings per organization and log these changes.
*   **Backend Worker (Post-Scan):** A background process (likely using BullMQ) triggered after a scan job's AI analysis completes, which applies the organization's current bypass settings to the flags generated by that specific job.
*   **Backend Worker (Retroactive):** A background process (likely using BullMQ) triggered manually via the API when settings are saved with the "Apply Retroactively" option, which applies the *current* settings to existing pending flags for the organization.
*   **Revert Mechanism:** An API endpoint to undo the flag status changes made by the *most recent* run of the bypass worker (either post-scan or retroactive) based on the last settings change.
*   **Audit Logging:** Detailed logging of when settings are changed (who, what settings) and when flags are automatically processed (which flag, what action, linked to the settings event).
*   **Per-Job Override:** Ability to disable the bypass feature for specific scan jobs.

## 1.1. Implementation Status (as of 2025-05-08)

*   **[COMPLETED]** Database Schema Changes (`prisma/schema.prisma`)
*   **[COMPLETED]** Backend Settings API (`/api/system-settings/*` endpoints in `systemSettingsRoutes.ts` and `organizationService.ts`)
*   **[COMPLETED]** Audit Logging for Settings Changes (within `organizationService.ts`)
*   **[COMPLETED]** Backend Worker (Post-Scan) Implementation (`src/workers/aiBypassProcessor.ts`)
*   **[COMPLETED]** Backend Worker (Retroactive) Implementation (`src/workers/retroactiveBypassProcessor.ts`)
*   **[COMPLETED]** BullMQ Queue Setup & Integration (`src/workers/queueRegistry.ts`, `organizationService.ts`, `scanJobService.ts`)
*   **[COMPLETED]** Frontend UI Changes (`AIConfidenceBypassControl.tsx`, `ConnectedNewScanJobModal.tsx`)
*   **[COMPLETED]** Scan Job Service Update (`scanJobService.ts`, `scanJobRoutes.ts` to handle `bypass_ai_processing` field)
*   **[BLOCKED]** Automated Tests for Service Layer (Blocked by Jest environment issues in Docker - see `docs/guides/database-migrations.md` for related troubleshooting)
*   **[COMPLETED]** Worker Runner Implementation (Requires a separate script to initialize and run BullMQ Worker instances)

## 2. How it Works (Backend Implementation Details)

### 2.1. Database Schema Changes (`prisma/schema.prisma`)

The following changes are required:

```prisma
// Add new enum values
enum ResolutionMethod {
  AI_AUTO_REMEDIATE // Added
  AI_AUTO_CLOSE     // Added
  HUMAN_REVIEW
}

// Add fields to organizations model
model organizations {
  // --- Existing fields ---
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String        @db.VarChar(255)
  settings                Json?         @default("{}")
  auto_approval_action    String?       @default("pending_remediation") @db.VarChar(50) // Consider if this is still needed or replaced
  created_at              DateTime      @default(now()) @db.Timestamp(6)
  updated_at              DateTime      @default(now()) @db.Timestamp(6)
  advertisers             advertisers[]
  publishers              publishers[]
  users                   users[]

  // --- New/Updated fields for AI Bypass ---
  auto_approval_threshold         Decimal? @db.Decimal(5, 2) // Stores threshold (0.00-1.00), null if disabled
  auto_approve_compliant_enabled  Boolean? @default(false)   // Enable auto-close for compliant flags?
  auto_remediate_violation_enabled Boolean? @default(false)   // Enable auto-remediate for violation flags?
}

// Add field to scan_jobs model
model scan_jobs {
  // --- Existing fields ---
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String?                  @db.VarChar(255)
  // ... other fields ...
  has_active_flags       Boolean                  @default(false)

  // --- New field for AI Bypass Override ---
  bypass_ai_processing   Boolean                  @default(false) // If true, worker skips this job
}

// Add field to audit_logs model
model audit_logs {
  // --- Existing fields ---
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action     String   @db.VarChar(255)
  details    Json
  user_id    String?  @db.Uuid
  created_at DateTime @default(now()) @db.Timestamp(6)
  users      users?   @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  // --- New field for linking actions to settings ---
  triggering_event_log_id String?  @db.Uuid // Links flag update log to the settings change log

  @@index([action], map: "audit_logs_action_index")
  @@index([created_at], map: "audit_logs_created_at_index")
  @@index([user_id], map: "audit_logs_user_id_index")
  @@index([triggering_event_log_id]) // Added index
}
```
**Action:** Schema changes applied via `prisma db execute` after troubleshooting migration inconsistencies. See `docs/guides/database-migrations.md`.

### 2.2. API Endpoints [COMPLETED]

*   **Save/Update Settings:** `POST /api/system-settings/ai-bypass-threshold`
    *   **Request Body:**
        ```json
        {
          "threshold": 85, // number (0-100) | null (to clear/disable)
          "autoApproveCompliant": true, // boolean
          "autoRemediateViolation": false, // boolean
          "applyRetroactively": false // boolean
        }
        ```
    *   **Handler Logic (`systemSettingsRoutes.ts` -> `organizationService.updateAiBypassThreshold`):**
        1.  Authenticate user, get `organizationId`.
        2.  Validate inputs (`threshold` 0-100 or null, booleans are booleans).
        3.  Convert `threshold` to `Decimal` (e.g., `new Decimal(threshold / 100)`) or `null`.
        4.  Determine final boolean values (if `threshold` is `null`, set booleans to `false`).
        5.  Call `organizationRepository.updateOrganization` with `auto_approval_threshold`, `auto_approve_compliant_enabled`, `auto_remediate_violation_enabled`.
        6.  Create `audit_logs` entry:
            *   `action`: "AI Bypass Settings Updated" or "AI Bypass Settings Cleared"
            *   `user_id`: ID of the logged-in user.
            *   `details`: `{ "organizationId": "...", "newThreshold": 85 | null, "newAutoApproveCompliant": true, "newAutoRemediateViolation": false }`
            *   Store the `id` of this audit log (`settingsLogId`).
        7.  If `applyRetroactively` is `true` AND `threshold` is not `null`: Add job to `retroactiveBypassQueue` with `{ organizationId, settingsLogId }`.
        8.  Return success response (e.g., 200 OK with updated settings).
*   **Get Current Settings:** `GET /api/system-settings/ai-bypass-settings`
    *   **Handler Logic (`systemSettingsRoutes.ts` -> `organizationService.getAiBypassSettings` [New Service Method]):**
        1.  Authenticate user, get `organizationId`.
        2.  Call `organizationRepository.getOrganizationById` selecting the relevant fields (`auto_approval_threshold`, `auto_approve_compliant_enabled`, `auto_remediate_violation_enabled`).
        3.  Convert `auto_approval_threshold` (Decimal) back to percentage (0-100) or `null`.
        4.  Return settings:
            ```json
            {
              "threshold": 85, // number | null
              "autoApproveCompliantEnabled": true, // boolean
              "autoRemediateViolationEnabled": false // boolean
            }
            ```
*   **Revert Last Batch:** `POST /api/system-settings/revert-auto-bypass`
    *   **Request Body:** (Potentially empty, relies on authenticated user's org)
    *   **Handler Logic (`systemSettingsRoutes.ts` -> `organizationService.revertLastAiBypassBatch` [New Service Method]):**
        1.  Authenticate user, get `organizationId` and `userId`.
        2.  Find the most recent settings change log: `prisma.audit_logs.findFirst({ where: { organization_id, action: { startsWith: "AI Bypass Settings" } }, orderBy: { created_at: 'desc' }, select: { id: true } })`. Store `latestSettingsLogId`. If none found, return error/no-op.
        3.  Find all relevant flag update logs: `prisma.audit_logs.findMany({ where: { triggering_event_log_id: latestSettingsLogId, action: { startsWith: "AI Bypass -" } }, select: { details: true } })`.
        4.  Extract unique `flag_id`s from the `details` JSON of these logs.
        5.  Fetch the current state of these flags: `prisma.flags.findMany({ where: { id: { in: flagIds } }, select: { id: true, resolution_method: true } })`.
        6.  Filter for flags where `resolution_method` is `AI_AUTO_CLOSE` or `AI_AUTO_REMEDIATE`. These are the only ones eligible for revert.
        7.  Perform updates in a transaction:
            *   For each eligible flag ID: `prisma.flags.update({ where: { id: flagId }, data: { status: 'PENDING', resolution_method: null } })`.
            *   For each reverted flag ID: `prisma.audit_logs.create({ data: { action: "AI Bypass Reverted", user_id: userId, details: { "flag_id": flagId, "reverted_from_setting_event": latestSettingsLogId } } })`.
        8.  Return success response (e.g., number of flags reverted).
*   **Scan Job Updates:** [COMPLETED]
    *   Updated `POST /api/scan-jobs/start-channel-scan` and `POST /api/scan-jobs/start-multi-target-scan` handlers (`scanJobRoutes.ts`) and the `initiateScanJob` function (`scanJobService.ts`) to accept and save the `bypass_ai_processing` boolean field during job creation. (Note: General PUT endpoint for updating existing jobs was not modified as part of this task).

### 2.3. Worker Logic (BullMQ Implemented) [COMPLETED]

*   **Worker - Main (`src/workers/aiBypassProcessor.ts`, listens to `aiBypassQueue`):**
    1.  **Job Data:** Receives `{ scan_job_id: string }`.
    2.  **Fetch Job & Org:** Get `scanJob` including `bypass_ai_processing` and related `advertiser` to fetch `organization_id`. If `bypass_ai_processing` is true, log and finish job successfully. Handles missing `organization_id`.
    3.  **Fetch Settings:** Get org settings (`threshold`, `approveEnabled`, `remediateEnabled`) via `organizationService.getAiBypassSettings`. If `threshold` is null or both booleans are false, log and finish job successfully.
    4.  **Fetch Settings Log ID:** Get `latestSettingsLogId` as described in Revert API step 2. If none, log warning and finish job.
    5.  **Fetch Flags:** `prisma.flags.findMany({ where: { scan_job_id, status: 'PENDING' }, select: { id, ai_confidence, ai_ruling } })`.
    6.  **Process Flags:** Loop through flags:
        *   If `flag.ai_confidence > threshold` (as Decimal):
            *   `isCompliant = flag.ai_ruling?.toLowerCase().includes('compliant')` (adjust based on actual ruling format)
            *   `isViolation = flag.ai_ruling?.toLowerCase().includes('violation')`
            *   **If `isCompliant` AND `approveEnabled`:**
                *   `prisma.flags.update({ where: { id: flag.id }, data: { status: 'CLOSED', resolution_method: 'AI_AUTO_CLOSE' } })`
                *   `prisma.audit_logs.create({ data: { action: "AI Bypass - Auto Closed", details: { flag_id: flag.id }, triggering_event_log_id: latestSettingsLogId } })`
            *   **Else If `isViolation` AND `remediateEnabled`:**
                *   `prisma.flags.update({ where: { id: flag.id }, data: { status: 'REMEDIATING', resolution_method: 'AI_AUTO_REMEDIATE' } })`
                *   `prisma.audit_logs.create({ data: { action: "AI Bypass - Auto Remediate", details: { flag_id: flag.id }, triggering_event_log_id: latestSettingsLogId } })`
    7.  **Error Handling:** Wrap database operations in try/catch blocks within the loop to handle individual flag processing errors gracefully. Log errors.
    8.  Finish job successfully.
*   **Worker - Retroactive (`src/workers/retroactiveBypassProcessor.ts`, listens to `retroactiveBypassQueue`):**
    1.  **Job Data:** Receives `{ organizationId: string, settingsLogId: string }`.
    2.  **Fetch Settings:** Get org settings (`threshold`, `approveEnabled`, `remediateEnabled`). If `threshold` is null or both booleans are false, log and finish job successfully.
    3.  **Fetch Flags:** `prisma.flags.findMany({ where: { content_items: { publisher: { organization_id: organizationId } }, status: 'PENDING' }, select: { id, ai_confidence, ai_ruling } })`.
    4.  **Process Flags:** Loop through flags (same logic as Main Worker steps 6.1 - 6.3), using the received `settingsLogId` when creating audit logs.
    5.  **Error Handling:** Similar to Main Worker.
    6.  Finish job successfully.
*   **Integration:**
    *   Define BullMQ queues (`aiBypassQueue`, `retroactiveBypassQueue`).
    *   Register processors (`aiBypassProcessor`, `retroactiveBypassProcessor`).
    *   Modified `scanJobService.checkAndUpdateParentScanJobStatus` to add a job to `aiBypassQueue` with `{ scan_job_id }` when the parent job reaches a final state ('COMPLETED' or 'COMPLETED_WITH_ERRORS').
    *   Ensured Settings API (`organizationService.updateAiBypassSettings`) adds job to `retroactiveBypassQueue` correctly when `applyRetroactively` is true.
    *   Created `src/utils/redisClient.ts` for Redis connection configuration.

## 3. Required Frontend Changes [COMPLETED]

*   **AI Bypass Settings Page (`AIConfidenceBypassControl.tsx`):**
    *   **On Load:** Fetches current settings via `GET /api/system-settings/ai-bypass-settings` using `dashboardService.getAiBypassSettings`.
    *   **Display:** Shows the currently saved threshold (or 'Disabled') and boolean states.
    *   **Initialize Controls:** Set the initial state of the slider, number input, and new toggles/checkboxes based on the fetched settings.
    *   **New Controls:**
        *   Toggle/Checkbox: "Automatically close compliant flags above threshold" (maps to `autoApproveCompliant`).
        *   Toggle/Checkbox: "Automatically send violation flags above threshold to remediation" (maps to `autoRemediateViolation`).
        *   Checkbox: "Apply this setting to all existing pending flags" (maps to `applyRetroactively`).
    *   **Buttons:**
        *   "Save Settings": Sends current control states (threshold, booleans, retroactive flag) to `POST /api/system-settings/ai-bypass-threshold`. Button disabled if no changes or threshold is null.
        *   "Clear/Disable Bypass": Sends `threshold: null` (and booleans as false) to `POST /api/system-settings/ai-bypass-threshold`. Button disabled if already disabled.
        *   "Revert Last Auto-Processing Batch": Calls `POST /api/system-settings/revert-auto-bypass`.
    *   Includes confirmation modals for all actions.
*   **Scan Job Create Page (`ConnectedNewScanJobModal.tsx`):**
    *   Added Checkbox: "Disable AI Bypass for this job?" (maps to `bypass_ai_processing`).
    *   Updated API call (`scanJobService.startMultiTargetScan`) to include this new field in the payload sent to `POST /api/scan-jobs/start-multi-target-scan`. Also updated the single-channel scan route (`POST /api/scan-jobs/start-channel-scan`) for consistency.

## 4. User Stories

1.  **Setting Up Auto-Processing for Future Scans:** As a Compliance Manager, I want to go to the AI Bypass settings, see current settings, set threshold to 90%, enable *only* "Auto-close compliant", save *without* applying retroactively, so that future scan job flags >90% confidence and compliant are auto-closed.
2.  **Setting Up Auto-Processing and Applying Retroactively:** As a Compliance Lead, I want to go to settings, set threshold to 85%, enable *both* "Auto-close compliant" and "Auto-remediate violations", check "Apply retroactively", so the system saves settings AND immediately processes all current `PENDING` flags based on these rules, and applies rules to future jobs.
3.  **Disabling Future Auto-Processing (Revised):** As a Compliance Manager, I want to go to settings, see current settings, click "Clear/Disable Bypass", so that the saved threshold/options are removed, ensuring no *new* flags from *future* scans are auto-processed. Past auto-processed flags remain unchanged.
4.  **Running a Scan Job with Bypass Enabled:** As a Compliance Analyst, I want to create a scan job, leaving "Disable AI Bypass" *unchecked*, so that after AI analysis, flags from *this job* are processed against the org's saved settings.
5.  **Running a Scan Job with Bypass Disabled:** As a Compliance Analyst, I want to create a scan job and *check* "Disable AI Bypass", so that *no* flags from *this specific job* are auto-processed, regardless of org settings.
6.  **Reverting the Last Auto-Processing Batch:** As a Compliance Manager, I want to click "Revert Last Auto-Processing Batch", so the system finds all flags automatically changed based on the *most recent* settings save (across any job or retroactive run) and reverts them to `PENDING` (if eligible).
7.  **Checking the Current Settings:** As a Team Member, I want to visit the settings page, so I can clearly see the currently saved threshold and which auto-actions are enabled before adjusting controls.
8.  **Auditing Auto-Processing Actions:** As an Auditor, I want to review audit logs, so I can see when bypass settings were changed (who, what), and which specific flags were auto-processed by the system based on those settings, linking flag changes back to the setting event.
